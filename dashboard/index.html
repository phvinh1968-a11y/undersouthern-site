<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>UNDERSOUTHERN · Streaming Dashboard (Admin/Artist)</title>

  <!-- Chart & PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#f7f8fa; --card:#ffffff; --muted:#6b7280; --accent:#ef4444;
      --line:#e5e7eb;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:var(--bg); color:#0f172a; padding:28px;
    }
    .container{max-width:1100px;margin:0 auto;}
    .title{font-size:20px;font-weight:700;display:flex;align-items:center;gap:10px;justify-content:space-between;}
    .subtitle{color:var(--muted);font-size:13px;margin-bottom:20px;}
    .card{background:var(--card);border-radius:10px;padding:20px;box-shadow:0 6px 18px rgba(15,23,42,0.06);border:1px solid #eef2f7;margin-bottom:22px;}
    .section-title{font-weight:700;font-size:16px;margin-bottom:10px;}
    .range-controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
    .range-btn{padding:8px 12px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer;font-weight:600;}
    .range-btn.active{background:#111827;color:#fff;border-color:#111827;}
    .custom-range{display:flex;gap:6px;align-items:center;}
    .custom-range input{padding:6px;border:1px solid var(--line);border-radius:8px;}
    .apply-btn{padding:8px 12px;background:#111827;color:#fff;border:none;border-radius:8px;cursor:pointer;}
    .platform-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px solid #f1f5f9;border-radius:8px;background:#fff;margin-bottom:10px;}
    .platform-name{font-weight:600;}
    .stream-num{font-weight:700;}
    footer{text-align:center;color:var(--muted);font-size:13px;margin-top:30px;}

    /* Login box */
    #loginBox{max-width:420px;margin:80px auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.08);}
    #loginBox h2{text-align:center;margin-bottom:16px;}
    #loginBox input{width:100%;padding:10px;margin-bottom:10px;border:1px solid #e5e7eb;border-radius:8px;}
    #loginBox button{width:100%;padding:10px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-weight:700;}
    .hidden{display:none;}

    /* admin tools */
    #adminTools{background:#fff3f3;padding:12px;border-radius:8px;border:1px solid #ffe4e6;margin-bottom:20px;}
    #clearData{margin-top:8px;background:var(--accent);color:#fff;border:none;border-radius:6px;padding:8px 10px;cursor:pointer;}

    /* logout */
    .logoutBtn{background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;}
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginBox">
  <h2>UNDERSOUTHERN Records — Sign in</h2>
  <input id="loginEmail" type="email" placeholder="Email (admin@undersouthern.asia for admin)"/>
  <input id="loginPass" type="password" placeholder="Password (admin123 for admin)"/>
  <button id="loginBtn">Login</button>
  <p style="color:#6b7280;font-size:13px;margin-top:8px;text-align:center">Artist: any email/password — Admin: admin@undersouthern.asia / admin123</p>
</div>

<!-- DASHBOARD -->
<div id="app" class="container hidden" aria-hidden="true">
  <div class="title">
    <div style="display:flex;align-items:center;gap:12px">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="6" fill="#ef4444"/><path d="M9.75 8.5V15.5L15.5 12L9.75 8.5Z" fill="#fff"/></svg>
      <div>
        <div style="font-weight:700">UNDERSOUTHERN · Streaming Dashboard</div>
        <div style="font-size:12px;color:var(--muted)">YouTube Art Tracks · Spotify · Apple · Amazon · Deezer · Pandora · UGC</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <button id="logout" class="logoutBtn">Logout</button>
    </div>
  </div>

  <!-- Admin tools (visible only to admin) -->
  <div id="adminTools" class="hidden">
    <strong>Admin Panel</strong>
    <p style="margin:6px 0;color:var(--muted);font-size:13px">Upload CSV earnings report để cập nhật dữ liệu dashboard.</p>
    <input type="file" id="csvFile" accept=".csv" />
    <br/>
    <button id="clearData">🗑 Clear saved CSV</button>
  </div>

  <!-- 1. Platform Streams Overview -->
  <div class="card">
    <div class="section-title">Platform Streams Overview</div>
    <div class="range-controls" id="platform-range">
      <button class="range-btn active" data-range="30">30 Days</button>
      <button class="range-btn" data-range="7">7 Days</button>
      <button class="range-btn" data-range="90">90 Days</button>
      <button class="range-btn" data-range="365">365 Days</button>
      <button class="range-btn" data-range="custom">Custom</button>
      <div class="custom-range" style="display:none">
        <input type="date"><input type="date">
        <button class="apply-btn">Apply</button>
      </div>
    </div>

    <div class="platform-row"><span class="platform-name">YouTube Art Tracks</span><span class="stream-num" id="ytArt">0</span></div>
    <div class="platform-row"><span class="platform-name">Spotify</span><span class="stream-num" id="spotify">0</span></div>
    <div class="platform-row"><span class="platform-name">Amazon Music</span><span class="stream-num" id="amazon">0</span></div>
    <div class="platform-row"><span class="platform-name">Apple Music</span><span class="stream-num" id="apple">0</span></div>
    <div class="platform-row"><span class="platform-name">Deezer</span><span class="stream-num" id="deezer">0</span></div>
    <div class="platform-row"><span class="platform-name">Pandora</span><span class="stream-num" id="pandora">0</span></div>
  </div>

  <!-- 2. YouTube UGC -->
  <div class="card">
    <div class="section-title">YouTube UGC Overview</div>
    <div class="range-controls" id="ugc-range">
      <button class="range-btn active" data-range="30">30 Days</button>
      <button class="range-btn" data-range="7">7 Days</button>
      <button class="range-btn" data-range="90">90 Days</button>
      <button class="range-btn" data-range="365">365 Days</button>
      <button class="range-btn" data-range="custom">Custom</button>
      <div class="custom-range" style="display:none">
        <input type="date"><input type="date">
        <button class="apply-btn">Apply</button>
      </div>
    </div>
    <div style="height:220px"><canvas id="ugcViews"></canvas></div>
  </div>

  <!-- 3. TikTok -->
  <div class="card">
    <div class="section-title">TikTok UGC Views</div>
    <div class="range-controls" id="tiktok-range">
      <button class="range-btn active" data-range="30">30 Days</button>
      <button class="range-btn" data-range="7">7 Days</button>
      <button class="range-btn" data-range="90">90 Days</button>
      <button class="range-btn" data-range="365">365 Days</button>
      <button class="range-btn" data-range="custom">Custom</button>
      <div class="custom-range" style="display:none">
        <input type="date"><input type="date">
        <button class="apply-btn">Apply</button>
      </div>
    </div>
    <div style="height:220px"><canvas id="tiktokViews"></canvas></div>
  </div>

  <!-- 4. Revenue Overview -->
  <div class="card">
    <div class="section-title">Revenue Overview</div>
    <div class="range-controls" id="revenue-range">
      <button class="range-btn active" data-range="30">30 Days</button>
      <button class="range-btn" data-range="7">7 Days</button>
      <button class="range-btn" data-range="90">90 Days</button>
      <button class="range-btn" data-range="365">365 Days</button>
      <button class="range-btn" data-range="custom">Custom</button>
      <div class="custom-range" style="display:none">
        <input type="date"><input type="date">
        <button class="apply-btn">Apply</button>
      </div>
    </div>
    <div style="height:220px"><canvas id="revenueChart"></canvas></div>
  </div>

  <!-- 5. Account Balance -->
  <div class="card">
    <div class="section-title">Account Balance</div>
    <div class="range-controls" id="balance-range">
      <button class="range-btn active" data-range="30">30 Days</button>
      <button class="range-btn" data-range="7">7 Days</button>
      <button class="range-btn" data-range="90">90 Days</button>
      <button class="range-btn" data-range="365">365 Days</button>
      <button class="range-btn" data-range="custom">Custom</button>
      <div class="custom-range" style="display:none">
        <input type="date"><input type="date">
        <button class="apply-btn">Apply</button>
      </div>
    </div>

    <table style="width:100%;font-size:14px;border-collapse:collapse" id="balance-table">
      <tr><td>Opening balance</td><td style="text-align:right;font-weight:600" id="opening">$0.00</td></tr>
      <tr><td>Earnings</td><td style="text-align:right;font-weight:600" id="earnings">$0.00</td></tr>
      <tr><td style="padding-top:8px;font-weight:700">Outstanding balance</td><td style="text-align:right;font-weight:700;padding-top:8px" id="outstanding">$0.00</td></tr>
    </table>
  </div>

  <footer>© 2025 UNDERSOUTHERN Records</footer>
</div>

<script>
/* ---------------------------
   Login / role management
   --------------------------- */
const loginBox = document.getElementById('loginBox');
const app = document.getElementById('app');
const adminTools = document.getElementById('adminTools');
const logoutBtn = document.getElementById('logout');
const csvInput = document.getElementById('csvFile');
const clearBtn = document.getElementById('clearData');

const ADMIN_EMAIL = "admin@undersouthern.asia";
const ADMIN_PASS = "admin123";

// show/hide UI based on role
function showAppForRole(role){
  loginBox.classList.add('hidden');
  app.classList.remove('hidden');
  app.setAttribute('aria-hidden','false');

  if(role === 'admin') {
    adminTools.classList.remove('hidden');
  } else {
    adminTools.classList.add('hidden');
  }

  // initialize dashboard (load saved CSV or demo)
  initDashboard();
}

document.getElementById('loginBtn').addEventListener('click', ()=>{
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  if(email === ADMIN_EMAIL && pass === ADMIN_PASS){
    localStorage.setItem('role','admin');
    showAppForRole('admin');
  } else if (email && pass) {
    localStorage.setItem('role','artist');
    localStorage.setItem('artistEmail', email);
    showAppForRole('artist');
  } else {
    alert('Vui lòng nhập email và mật khẩu.');
  }
});

logoutBtn.addEventListener('click', ()=>{
  localStorage.removeItem('role');
  // do not clear saved CSV on logout
  loginBox.classList.remove('hidden');
  app.classList.add('hidden');
  app.setAttribute('aria-hidden','true');
});

/* ---------------------------
   CSV Upload / persistence
   --------------------------- */
csvInput && csvInput.addEventListener('change', (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  Papa.parse(file, {
    header: true, skipEmptyLines: true,
    complete: (res) => {
      const data = res.data;
      // save raw CSV rows
      localStorage.setItem('undersouthernEarningsCSV', JSON.stringify(data));
      // update dashboard immediately
      applyCSVDataToDashboard(data);
      alert('✅ CSV uploaded & saved (artists will see updated data).');
    }
  });
});

clearBtn && clearBtn.addEventListener('click', ()=>{
  localStorage.removeItem('undersouthernEarningsCSV');
  alert('Đã xóa CSV đã lưu. Dashboard sẽ trở về dữ liệu demo.');
  // rebuild demo
  buildPlatform();
  buildYouTubeUGC();
  buildTikTokUGC();
  buildRevenue();
  buildBalance();
});

/* ---------------------------
   Dashboard original code (randData, charts, range controls)
   --------------------------- */

function randData(n, base, v){
  const labels=[],data=[];
  const today=new Date();
  for(let i=n-1;i>=0;i--){
    const d=new Date(today.getFullYear(),today.getMonth(),today.getDate()-i);
    labels.push(`${d.getDate()}/${d.getMonth()+1}`);
    data.push(Math.max(0,Math.round(base+Math.random()*v)));
  }
  return {labels,data};
}

function attachRangeControls(sectionId, updateFunc){
  const section=document.getElementById(sectionId);
  if(!section) return;
  const btns=section.querySelectorAll(".range-btn");
  const customBox=section.querySelector(".custom-range");
  btns.forEach(btn=>{
    btn.addEventListener("click",()=>{
      btns.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const range=btn.dataset.range;
      if(range==="custom") customBox.style.display="flex";
      else {customBox.style.display="none"; updateFunc(parseInt(range));}
    });
  });
  const apply=section.querySelector(".apply-btn");
  if(apply) apply.addEventListener("click",()=>updateFunc(30));
}

let ugcChart,tiktokChart,revChart;

function buildPlatform(n=30){
  // Use CSV totals if present
  const csv = JSON.parse(localStorage.getItem('undersouthernEarningsCSV')||'[]');
  if(csv.length>0){
    // compute totals by DSP
    const totals = {};
    csv.forEach(r=>{
      const dsp = (r["Digital Service Provider"] || r["Digital Service Provider Name"] || r["DSP"] || "").trim();
      const cnt = parseInt(r["Count"]||r["count"]||r["Streams"]||0) || 0;
      totals[dsp] = (totals[dsp]||0) + cnt;
    });
    document.getElementById("ytArt").textContent = totals["YouTube Streaming"]||totals["YouTube"]||0;
    document.getElementById("spotify").textContent = totals["Spotify"]||0;
    document.getElementById("amazon").textContent = totals["Amazon Music"]||0;
    document.getElementById("apple").textContent = totals["Apple Music"]||0;
    document.getElementById("deezer").textContent = totals["Deezer"]||0;
    document.getElementById("pandora").textContent = totals["Pandora"]||0;
    return;
  }

  // demo random data
  const yt=randData(n,120,80);
  const sp=randData(n,30,10);
  const am=randData(n,10,5);
  const ap=randData(n,20,10);
  const dz=randData(n,5,2);
  const pd=randData(n,3,1);
  const total=a=>a.reduce((x,y)=>x+y,0);
  document.getElementById("ytArt").textContent=total(yt.data);
  document.getElementById("spotify").textContent=total(sp.data);
  document.getElementById("amazon").textContent=total(am.data);
  document.getElementById("apple").textContent=total(ap.data);
  document.getElementById("deezer").textContent=total(dz.data);
  document.getElementById("pandora").textContent=total(pd.data);
}

function buildYouTubeUGC(n=30){
  const csv = JSON.parse(localStorage.getItem('undersouthernEarningsCSV')||'[]');
  if(csv.length>0){
    // attempt to build timeseries from Date + Count for YouTube
    const byDate = {};
    csv.forEach(r=>{
      const dsp = r["Digital Service Provider"]||"";
      if(!/youtube/i.test(dsp)) return;
      const date = r["Date"] || r["Reporting Period"] || r["reporting_period"] || "";
      const cnt = parseInt(r["Count"])||0;
      const key = date || new Date().toISOString().slice(0,10);
      byDate[key] = (byDate[key]||0) + cnt;
    });
    const labels = Object.keys(byDate).slice(-30);
    const data = labels.map(k=>byDate[k]);
    if(ugcChart) ugcChart.destroy();
    ugcChart=new Chart(document.getElementById("ugcViews"),{
      type:"line",
      data:{labels:data.length?labels:randData(n,1,0).labels,datasets:[{label:"UGC Views",data:data.length?data:randData(n,600,300).data,borderColor:"rgba(239,68,68,0.9)",fill:true,backgroundColor:"rgba(239,68,68,0.1)"}]},
      options:{plugins:{legend:{position:"bottom"}}}
    });
    return;
  }

  const data=randData(n,600,300);
  if(ugcChart)ugcChart.destroy();
  ugcChart=new Chart(document.getElementById("ugcViews"),{
    type:"line",
    data:{labels:data.labels,datasets:[{label:"UGC Views",data:data.data,borderColor:"rgba(239,68,68,0.9)",fill:true,backgroundColor:"rgba(239,68,68,0.1)"}]},
    options:{plugins:{legend:{position:"bottom"}}}
  });
}

function buildTikTokUGC(n=30){
  const csv = JSON.parse(localStorage.getItem('undersouthernEarningsCSV')||'[]');
  if(csv.length>0){
    // approximate: use rows where DSP contains 'TikTok'
    const byDateUGC = {}, byDatePGC = {};
    csv.forEach(r=>{
      const dsp = r["Digital Service Provider"]||"";
      if(!/tiktok/i.test(dsp)) return;
      const date = r["Date"] || r["Reporting Period"] || new Date().toISOString().slice(0,10);
      const cnt = parseInt(r["Count"])||0;
      // rough split: if Content Type contains 'PGC' use PGC else UGC (best-effort)
      const content = (r["Content Type"]||"").toLowerCase();
      if(content.includes("pgc") || content.includes("program")) byDatePGC[date] = (byDatePGC[date]||0)+cnt;
      else byDateUGC[date] = (byDateUGC[date]||0)+cnt;
    });
    const labels = Object.keys(byDateUGC).slice(-30) || Object.keys(byDatePGC).slice(-30);
    const pgc = labels.map(k=>byDatePGC[k]||0);
    const ugc = labels.map(k=>byDateUGC[k]||0);
    if(tiktokChart) tiktokChart.destroy();
    tiktokChart=new Chart(document.getElementById("tiktokViews"),{
      type:"bar",
      data:{labels:labels.length?labels:randData(n,0,0).labels,datasets:[
        {label:"PGC",data:pgc.length?pgc:randData(n,20,10).data,backgroundColor:"rgba(34,197,94,0.8)"},
        {label:"UGC",data:ugc.length?ugc:randData(n,100,40).data,backgroundColor:"rgba(239,68,68,0.9)"}
      ]},
      options:{plugins:{legend:{position:"bottom"}}}
    });
    return;
  }

  const labels=randData(n,0,0).labels;
  const pgc=randData(n,20,10).data;
  const ugc=randData(n,100,40).data;
  if(tiktokChart)tiktokChart.destroy();
  tiktokChart=new Chart(document.getElementById("tiktokViews"),{
    type:"bar",
    data:{labels:labels,datasets:[
      {label:"PGC",data:pgc,backgroundColor:"rgba(34,197,94,0.8)"},
      {label:"UGC",data:ugc,backgroundColor:"rgba(239,68,68,0.9)"}
    ]},
    options:{plugins:{legend:{position:"bottom"}}}
  });
}

function buildRevenue(n=30){
  const csv = JSON.parse(localStorage.getItem('undersouthernEarningsCSV')||'[]');
  if(csv.length>0){
    // build timeseries of royalty by date (best-effort)
    const byDate = {};
    csv.forEach(r=>{
      const date = r["Date"]||r["Reporting Period"]||new Date().toISOString().slice(0,10);
      const royalty = parseFloat(r["Royalty ($US)"])||0;
      byDate[date] = (byDate[date]||0) + royalty;
    });
    const labels = Object.keys(byDate).slice(-30);
    const data = labels.map(k=>parseFloat(byDate[k].toFixed(4)));
    if(revChart) revChart.destroy();
    revChart=new Chart(document.getElementById("revenueChart"),{
      type:"line",
      data:{labels:labels.length?labels:randData(n,5,2).labels,datasets:[{label:"Total Revenue (USD)",data:data.length?data:randData(n,5,2).data,borderColor:"rgba(59,130,246,0.9)",fill:true,backgroundColor:"rgba(59,130,246,0.1)"}]},
      options:{plugins:{legend:{position:"bottom"}}}
    });
    return;
  }

  const data=randData(n,5,2);
  if(revChart)revChart.destroy();
  revChart=new Chart(document.getElementById("revenueChart"),{
    type:"line",
    data:{labels:data.labels,datasets:[{label:"Total Revenue (USD)",data:data.data,borderColor:"rgba(59,130,246,0.9)",fill:true,backgroundColor:"rgba(59,130,246,0.1)"}]},
    options:{plugins:{legend:{position:"bottom"}}}
  });
}

function buildBalance(n=30){
  // if CSV present, use royalty total
  const csv = JSON.parse(localStorage.getItem('undersouthernEarningsCSV')||'[]');
  if(csv.length>0){
    let totalRoyalty = 0;
    csv.forEach(r=> totalRoyalty += parseFloat(r["Royalty ($US)"])||0 );
    const opening = parseFloat(document.getElementById("opening").textContent.replace("$","")) || 0;
    document.getElementById("earnings").textContent = `$${totalRoyalty.toFixed(4)}`;
    document.getElementById("outstanding").textContent = `$${(opening+totalRoyalty).toFixed(4)}`;
    return;
  }

  const base=1000;
  const earn=(Math.random()*100*n/30).toFixed(2);
  document.getElementById("opening").textContent=`$${base.toFixed(2)}`;
  document.getElementById("earnings").textContent=`$${earn}`;
  document.getElementById("outstanding").textContent=`$${(base+parseFloat(earn)).toFixed(2)}`;
}

/* Attach ranges for each section (independent) */
attachRangeControls("platform-range", buildPlatform);
attachRangeControls("ugc-range", buildYouTubeUGC);
attachRangeControls("tiktok-range", buildTikTokUGC);
attachRangeControls("revenue-range", buildRevenue);
attachRangeControls("balance-range", buildBalance);

/* initial build helpers */
function initDashboard(){
  // if CSV stored, apply CSV-based builds
  const saved = JSON.parse(localStorage.getItem('undersouthernEarningsCSV')||'[]');
  if(saved.length>0){
    applyCSVDataToDashboard(saved);
  } else {
    // demo builds
    buildPlatform();
    buildYouTubeUGC();
    buildTikTokUGC();
    buildRevenue();
    buildBalance();
  }
}

/* apply CSV rows to update everything */
function applyCSVDataToDashboard(csvRows){
  // store if not already stored
  if(!localStorage.getItem('undersouthernEarningsCSV')) localStorage.setItem('undersouthernEarningsCSV', JSON.stringify(csvRows));

  // update platform totals
  buildPlatform();
  // update charts
  buildYouTubeUGC();
  buildTikTokUGC();
  buildRevenue();
  // update balance (royalty)
  buildBalance();
}

/* on page load: if session exists, show dashboard */
window.addEventListener('load', ()=>{
  const role = localStorage.getItem('role');
  if(role) showAppForRole(role);
});
</script>
</body>
</html>

