<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Your Music</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #fcfcfd; }
        
        /* Force sharp corners */
        input, select, textarea, button, div, section, span {
            border-radius: 0 !important;
        }
        
        /* Custom Tag Style */
        .artist-tag {
            display: inline-flex;
            align-items: center;
            background: #000;
            color: #fff;
            padding: 4px 10px;
            font-size: 12px;
            margin-right: 8px;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .artist-tag button {
            margin-left: 8px;
            color: #999;
        }
        .artist-tag button:hover {
            color: #ff4d4d;
        }

        /* Custom file input appearance */
        input[type="file"]::file-selector-button {
            background: #000;
            color: #fff;
            border: none;
            padding: 8px 16px;
            margin-right: 16px;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 11px;
            font-weight: 700;
        }
        input[type="file"]::file-selector-button:hover {
            background: #333;
        }
    </style>
</head>
<body class="text-slate-800 pb-20">

    <header class="sticky top-0 z-50 bg-[#fcfcfd]/80 backdrop-blur-md border-b border-slate-100 mb-12">
        <div class="max-w-xl mx-auto px-6 py-10">
            <div class="border-l-4 border-black pl-6">
                <h1 class="text-3xl font-bold tracking-tight text-slate-900">Submit your music</h1>
                <p class="text-slate-500 mt-2 text-sm">Provide your details and assets for global distribution.</p>
            </div>
        </div>
    </header>

    <div class="max-w-xl mx-auto px-6">
        <form id="musicForm" class="space-y-12" onsubmit="handleFormSubmit(event)">
            
            <section class="space-y-8">
                <h2 class="text-sm font-semibold text-slate-400 border-b border-slate-100 pb-2">Release details</h2>

                <div class="space-y-8"> 
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Email address <span class="text-red-500">*</span></label>
                        <input type="email" id="email" required placeholder="artist@example.com" 
                            class="w-full bg-white border border-slate-300 px-4 py-3 focus:border-black outline-none transition-all font-sans">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Release title <span class="text-red-500">*</span></label>
                        <input type="text" id="title" required placeholder="Enter track or album name" 
                            class="w-full bg-white border border-slate-300 px-4 py-3 focus:border-black outline-none transition-all text-lg font-semibold tracking-tight">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Primary artist <span class="text-red-500">*</span></label>
                        <div class="flex">
                            <input type="text" id="primaryInput" placeholder="Add artist..." 
                                class="w-full bg-white border border-slate-300 px-4 py-3 focus:border-black outline-none transition-all">
                            <button type="button" onclick="addTag('primaryInput', 'primaryContainer', true)" class="bg-black text-white px-5 hover:bg-slate-800 transition-colors">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                        <div id="primaryContainer" class="flex flex-wrap"></div>
                        <input type="text" id="primaryValidator" required class="opacity-0 h-0 w-0 pointer-events-none block">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Featured artist (optional)</label>
                        <div class="flex">
                            <input type="text" id="featInput" placeholder="Add featured artist..." 
                                class="w-full bg-white border border-slate-300 px-4 py-3 focus:border-black outline-none transition-all">
                            <button type="button" onclick="addTag('featInput', 'featContainer', false)" class="bg-black text-white px-5 hover:bg-slate-800 transition-colors">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                        <div id="featContainer" class="flex flex-wrap"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Producer <span class="text-red-500">*</span></label>
                        <div class="flex">
                            <input type="text" id="prodInput" placeholder="Add producer name..." 
                                class="w-full bg-white border border-slate-300 px-4 py-3 focus:border-black outline-none transition-all">
                            <button type="button" onclick="addTag('prodInput', 'prodContainer', true)" class="bg-black text-white px-5 hover:bg-slate-800 transition-colors">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                        <div id="prodContainer" class="flex flex-wrap"></div>
                        <input type="text" id="prodValidator" required class="opacity-0 h-0 w-0 pointer-events-none block">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Primary genre <span class="text-red-500">*</span></label>
                        <select id="genre" required class="w-full bg-white border border-slate-300 px-4 py-3 focus:border-black outline-none transition-all appearance-none">
                            <option value="">Select a genre</option>
                            <option>Alternative</option><option>Alternative Rock</option><option>Alternativo & Rock Latino</option><option>Anime</option><option>Baladas y Boleros</option><option>Big Band</option><option>Blues</option><option>Brazilian</option><option>C-Pop</option><option>Cantopop/HK-Pop</option><option>Children's</option><option>Chinese</option><option>Christian</option><option>Classical</option><option>Comedy</option><option>Contemporary Latin</option><option>Country</option><option>Dance</option><option>Easy Listening</option><option>Educational</option><option>Electronic</option><option>Enka</option><option>Experimental</option><option>Fitness & Workout</option><option>Folk</option><option>French Pop</option><option>German Folk</option><option>German Pop</option><option>Hip-Hop/Rap</option><option>Holiday</option><option>Indo Pop</option><option>Inspirational</option><option>Instrumental</option><option>J-Pop</option><option>Jazz</option><option>K-Pop</option><option>Karaoke</option><option>Kayokyoku</option><option>Latin</option><option>Latin Jazz</option><option>Metal</option><option>New Age</option><option>Opera</option><option>Original Pilipino Music</option><option>Pop</option><option>Pop Latino</option><option>Punk</option><option>R&B</option><option>Raíces</option><option>Reggae</option><option>Reggaeton y Hip-Hop</option><option>Regional Mexicano</option><option>Rock</option><option>Salsa y Tropical</option><option>Singer/Songwriter</option><option>Soul</option><option>Soundtrack</option><option>Spoken Word</option><option>Tai-Pop</option><option>Thai Pop</option><option>Trot</option><option>Vocal/Nostalgia</option><option>World</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Language <span class="text-red-500">*</span></label>
                        <select id="language" required class="w-full bg-white border border-slate-300 px-4 py-3 focus:border-black outline-none transition-all appearance-none">
                            <option value="">Select lyrics language</option>
                            <option>Vietnamese (VI)</option><option>English (EN)</option><option>Korean (KO)</option><option>Japanese (JA)</option><option>Chinese (ZH)</option><option>French (FR)</option><option>Spanish (ES)</option><option>German (DE)</option><option>Italian (IT)</option><option>Portuguese (PT)</option><option>Russian (RU)</option><option>Arabic (AR)</option><option>Hindi (HI)</option><option>Thai (TH)</option><option>Indonesian (ID)</option><option>Bengali (BN)</option><option>Turkish (TR)</option><option>Malay (MS)</option><option>Urdu (UR)</option><option>Persian (FA)</option><option>Swahili (SW)</option><option>Tamil (TA)</option><option>Telugu (TE)</option><option>Marathi (MR)</option><option>Gujarati (GU)</option><option>Kannada (KN)</option><option>Punjabi (PA)</option><option>Filipino (TL)</option><option>Malayalam (ML)</option><option>Sinhala (SI)</option><option>Burmese (MY)</option><option>Khmer (KM)</option><option>Lao (LO)</option><option>Nepali (NE)</option><option>Pashto (PS)</option><option>Hebrew (HE)</option><option>Greek (EL)</option><option>Dutch (NL)</option><option>Swedish (SV)</option><option>Norwegian (NO)</option><option>Danish (DA)</option><option>Finnish (FI)</option><option>Polish (PL)</option><option>Czech (CS)</option><option>Hungarian (HU)</option><option>Romanian (RO)</option><option>Bulgarian (BG)</option><option>Serbian (SR)</option><option>Croatian (HR)</option><option>Slovak (SK)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Lyrics <span class="text-red-500">*</span></label>
                        <textarea id="lyrics" required rows="8" placeholder="Paste your full song lyrics here..." 
                            class="w-full bg-white border border-slate-300 px-4 py-3 focus:border-black outline-none transition-all font-sans text-sm resize-none"></textarea>
                    </div>
                </div>
            </section>

            <section class="space-y-8">
                <h2 class="text-sm font-semibold text-slate-400 border-b border-slate-100 pb-2">Asset Upload</h2>
                <div class="space-y-8">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Audio master file (.flac, .wav) <span class="text-red-500">*</span></label>
                        <input type="file" id="audioFile" required accept=".flac, .wav" onchange="validateAudio(this)"
                            class="w-full bg-white border border-slate-300 px-4 py-2.5 focus:border-black outline-none transition-all font-sans text-sm">
                        <p id="audioStatus" class="text-[11px] mt-2 text-slate-400 flex items-center gap-1.5"><i class="fa-solid fa-circle-info"></i> Format: FLAC or WAV only</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Cover artwork file (.jpg) <span class="text-red-500">*</span></label>
                        <input type="file" id="artFile" required accept=".jpg,.jpeg" onchange="validateArtwork(this)"
                            class="w-full bg-white border border-slate-300 px-4 py-2.5 focus:border-black outline-none transition-all font-sans text-sm">
                        <p id="artStatus" class="text-[11px] mt-2 text-slate-400 flex items-center gap-1.5"><i class="fa-solid fa-image"></i> Specs: 3000x3000px, Square, JPG only</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1.5">Notes (optional)</label>
                        <textarea id="notes" rows="4" placeholder="Enter additional notes..." 
                            class="w-full bg-white border border-slate-300 px-4 py-3 focus:border-black outline-none transition-all font-sans text-sm resize-none"></textarea>
                        <p class="text-[11px] mt-2 text-slate-400 flex items-start gap-1.5 leading-relaxed">
                            <i class="fa-solid fa-circle-info mt-0.5"></i> 
                            <span>Include a music preview (15–60 seconds), any important information about the song, and a link to your artist's Spotify page (if available).</span>
                        </p>
                    </div>
                </div>
            </section>

            <div class="pt-4">
                <button type="submit" id="submitBtn" class="w-full bg-black text-white py-5 font-bold uppercase tracking-widest hover:bg-slate-800 transition-all active:scale-[0.99]">
                    Submit release
                </button>
            </div>
        </form>
    </div>

    <script>
        // 2. CẤU HÌNH API SUPABASE
        const SUPABASE_URL = 'https://jslhpiyvaizwtnrnswhr.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_gzJk-CHEt3rOZJUj5vKKIg_GFvmhaxD'; // Lấy từ hình ảnh của bạn
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let counts = { primaryContainer: 0, prodContainer: 0, featContainer: 0 };
        let tagsData = { primaryContainer: [], featContainer: [], prodContainer: [] };

        function addTag(inputId, containerId, isRequired) {
            const input = document.getElementById(inputId);
            const container = document.getElementById(containerId);
            const value = input.value.trim();
            if (value !== "") {
                const tag = document.createElement('span');
                tag.className = 'artist-tag';
                tag.innerHTML = `${value} <button type="button" onclick="removeTag(this, '${containerId}', '${value}', ${isRequired})"><i class="fa-solid fa-xmark"></i></button>`;
                container.appendChild(tag);
                
                // Lưu dữ liệu tag vào mảng
                tagsData[containerId].push(value);
                
                input.value = "";
                if (isRequired) { counts[containerId]++; updateValidator(containerId); }
            }
        }

        function removeTag(btn, containerId, value, isRequired) {
            btn.parentElement.remove();
            // Xóa dữ liệu khỏi mảng
            tagsData[containerId] = tagsData[containerId].filter(t => t !== value);
            if (isRequired) { counts[containerId]--; updateValidator(containerId); }
        }

        function updateValidator(containerId) {
            const validatorId = containerId === 'primaryContainer' ? 'primaryValidator' : 'prodValidator';
            const validator = document.getElementById(validatorId);
            if(validator) validator.value = counts[containerId] > 0 ? "added" : "";
        }

        function validateAudio(input) {
            const status = document.getElementById('audioStatus');
            const file = input.files[0];
            if (file) {
                status.innerHTML = `<i class="fa-solid fa-circle-check text-green-600"></i> <span class="text-green-600 font-medium">Ready: ${file.name}</span>`;
            } else {
                status.innerHTML = `<i class="fa-solid fa-circle-info"></i> Format: FLAC or WAV only`;
            }
        }

        function validateArtwork(input) {
            const file = input.files[0];
            const status = document.getElementById('artStatus');
            if (!file) {
                status.innerHTML = `<i class="fa-solid fa-image"></i> Specs: 3000x3000px, Square, JPG only`;
                return;
            }

            const img = new Image();
            img.src = URL.createObjectURL(file);
            img.onload = function() {
                const width = this.width;
                const height = this.height;
                if (width === 3000 && height === 3000) {
                    status.innerHTML = `<i class="fa-solid fa-circle-check text-green-600"></i> <span class="text-green-600 font-medium">Valid: ${file.name}</span>`;
                } else {
                    alert(`Error: Artwork must be exactly 3000x3000px. Your file is ${width}x${height}px.`);
                    input.value = "";
                    status.innerHTML = `<i class="fa-solid fa-triangle-exclamation text-red-500"></i> <span class="text-red-500 font-medium">Invalid size: ${width}x${height}px.</span>`;
                }
            };
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('submitBtn');
            
            btn.innerText = "UPLOADING...";
            btn.disabled = true;

            try {
                const audioFile = document.getElementById('audioFile').files[0];
                const artFile = document.getElementById('artFile').files[0];

                // 1. Tải tệp lên Storage bucket 'music-assets'
                const audioPath = `audio/${Date.now()}_${audioFile.name}`;
                const artPath = `art/${Date.now()}_${artFile.name}`;

                const { error: audioErr } = await supabaseClient.storage.from('music-assets').upload(audioPath, audioFile);
                if (audioErr) throw audioErr;

                const { error: artErr } = await supabaseClient.storage.from('music-assets').upload(artPath, artFile);
                if (artErr) throw artErr;

                // 2. Lưu thông tin vào Database Table 'submissions'
                const { error: dbErr } = await supabaseClient.from('submissions').insert([{
                    email: document.getElementById('email').value,
                    title: document.getElementById('title').value,
                    primary_artists: tagsData.primaryContainer,
                    featured_artists: tagsData.featContainer,
                    producers: tagsData.prodContainer,
                    genre: document.getElementById('genre').value,
                    language: document.getElementById('language').value,
                    lyrics: document.getElementById('lyrics').value,
                    audio_url: audioPath,
                    art_url: artPath,
                    notes: document.getElementById('notes').value
                }]);

                if (dbErr) throw dbErr;

                alert("Release submitted successfully!");
                
                // RESET FORM VỀ BAN ĐẦU
                form.reset();
                document.getElementById('primaryContainer').innerHTML = "";
                document.getElementById('featContainer').innerHTML = "";
                document.getElementById('prodContainer').innerHTML = "";
                counts = { primaryContainer: 0, prodContainer: 0, featContainer: 0 };
                tagsData = { primaryContainer: [], featContainer: [], prodContainer: [] };
                document.getElementById('primaryValidator').value = "";
                document.getElementById('prodValidator').value = "";
                document.getElementById('audioStatus').innerHTML = `<i class="fa-solid fa-circle-info"></i> Format: FLAC or WAV only`;
                document.getElementById('artStatus').innerHTML = `<i class="fa-solid fa-image"></i> Specs: 3000x3000px, Square, JPG only`;

                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (err) {
                alert("Submission failed: " + err.message);
            } finally {
                btn.innerText = "SUBMIT RELEASE";
                btn.disabled = false;
            }
        }

        document.querySelectorAll('input').forEach(el => {
            el.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !el.type.includes('file')) {
                    e.preventDefault();
                    if (el.id === 'primaryInput') addTag('primaryInput', 'primaryContainer', true);
                    if (el.id === 'featInput') addTag('featInput', 'featContainer', false);
                    if (el.id === 'prodInput') addTag('prodInput', 'prodContainer', true);
                }
            });
        });
    </script>
</body>
</html>
