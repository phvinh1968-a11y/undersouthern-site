<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Catalog Management - UNDERSOUTHERN</title>

<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/phvinh1968-a11y/my-images/main/logoblack.png">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root {
    --bg-system: #f8fafc;
    --card-bg: #ffffff;
    --primary-dark: #0f172a;
    --accent: #000000;
    --border-soft: #f1f5f9;
    --text-main: #1e293b;
    --text-sub: #64748b;
  }

  body { 
    font-family: 'Plus Jakarta Sans', sans-serif; 
    background: var(--bg-system); 
    color: var(--text-main); 
    margin: 0; 
    -webkit-font-smoothing: antialiased;
  }

  /* --- Giao diện Analytics --- */
  .glass-header {
    height: 72px; background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(16px); border-bottom: 1px solid var(--border-soft);
    position: sticky; top: 0; z-index: 1000; display: flex; align-items: center; justify-content: space-between; padding: 0 40px;
  }

  .main-container { max-width: 1440px; margin: 0 auto; padding: 32px 40px; }

  .analytic-card {
    background: var(--card-bg); border-radius: 28px; border: 1px solid var(--border-soft);
    padding: 32px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.04);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .analytic-card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.08); }

  /* --- Form Elements --- */
  .input-group label { display: block; font-size: 11px; font-weight: 800; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 10px; }
  
  .input-field {
    width: 100%; padding: 15px 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 16px;
    font-size: 14px; font-weight: 600; transition: all 0.2s; outline: none;
  }
  .input-field:focus { border-color: var(--accent); background: #fff; box-shadow: 0 0 0 4px rgba(0,0,0,0.05); }
  .input-field:disabled { background: #f1f5f9; cursor: not-allowed; opacity: 0.6; }

  /* --- Artwork --- */
  .artwork-uploader {
    width: 100%; aspect-ratio: 1/1; border: 2.5px dashed #e2e8f0; border-radius: 24px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    cursor: pointer; overflow: hidden; position: relative; background: #fcfcfc; transition: 0.3s;
  }
  .artwork-uploader:hover { border-color: var(--accent); background: #f8fafc; }
  .artwork-uploader img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 10; display: none; }
  .artwork-uploader i { font-size: 40px; color: #cbd5e1; margin-bottom: 15px; }

  /* --- Table Custom --- */
  table { width: 100%; border-spacing: 0 10px; border-collapse: separate; }
  th { padding: 12px 24px; font-size: 10px; font-weight: 800; color: var(--text-sub); text-transform: uppercase; text-align: left; letter-spacing: 0.05em; }
  td { padding: 22px; background: #fff; border-top: 1px solid var(--border-soft); border-bottom: 1px solid var(--border-soft); }
  td:first-child { border-left: 1px solid var(--border-soft); border-top-left-radius: 20px; border-bottom-left-radius: 20px; }
  td:last-child { border-right: 1px solid var(--border-soft); border-top-right-radius: 20px; border-bottom-right-radius: 20px; }

  /* --- Badges --- */
  .badge { padding: 6px 14px; border-radius: 100px; font-size: 10px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.02em; }
  .badge-draft { background: #f1f5f9; color: #475569; }
  .badge-pending { background: #fffbeb; color: #b45309; }
  .badge-released { background: #f0fdf4; color: #15803d; }
  .badge-rejected { background: #fff1f2; color: #be123c; }

  /* --- Action Modal --- */
  .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 2000; }
  .modal-sheet { background: #fff; padding: 48px; border-radius: 40px; width: 100%; max-width: 520px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.3); }

  .btn-analytics { padding: 14px 32px; border-radius: 18px; font-weight: 800; font-size: 14px; transition: all 0.3s; display: inline-flex; align-items: center; gap: 12px; }
  .btn-primary-dark { background: var(--primary-dark); color: white; }
  .btn-primary-dark:hover { background: #1e293b; transform: scale(1.02); }

  .track-row { 
    display: grid; grid-template-columns: 50px 1.5fr 1fr 1fr 50px; gap: 15px; 
    align-items: center; background: #f8fafc; padding: 18px; border-radius: 20px; margin-bottom: 12px; border: 1px solid #f1f5f9;
  }
  .track-row input { margin-bottom: 0 !important; }

  .hidden { display: none !important; }
  .fade-in { animation: fadeIn 0.5s ease-out forwards; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<div class="modal-overlay" id="actionModal">
  <div class="modal-sheet fade-in text-center">
    <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-6">
      <i class="fa-solid fa-cloud-arrow-up text-2xl"></i>
    </div>
    <h2 id="mTitle" class="text-3xl font-black mb-3 tracking-tighter">Confirm Submission</h2>
    <p id="mDesc" class="text-slate-500 text-sm mb-10 leading-relaxed px-4">Synchronize your release metadata with the UNDERSOUTHERN distribution node?</p>
    
    <div id="mRejectContainer" class="hidden mb-8 text-left">
      <label class="text-[10px] font-black text-rose-500 uppercase mb-2 block tracking-widest ml-1">Official Rejection Log</label>
      <textarea id="mRejectReason" class="input-field border-rose-100 bg-rose-50 h-32" placeholder="Describe metadata issues or rights violations..."></textarea>
    </div>

    <div class="bg-slate-50 p-6 border border-slate-100 rounded-3xl mb-10 flex gap-4 items-start cursor-pointer" onclick="toggleModalCheck()">
      <input type="checkbox" id="mCheck" class="w-6 h-6 mt-0.5 accent-black cursor-pointer">
      <label class="text-[11px] font-bold leading-relaxed text-slate-600 text-left cursor-pointer">I verify that all audio assets, artwork, and metadata are correct and I hold the legal rights to distribute this content.</label>
    </div>

    <div class="flex gap-4">
      <button class="flex-1 py-4 rounded-2xl font-black text-slate-400 hover:text-slate-600 transition" onclick="closeModal()">Cancel</button>
      <button class="flex-1 btn-primary-dark justify-center py-4 rounded-2xl opacity-20" id="mConfirmBtn" disabled onclick="executeFinalAction()">Execute</button>
    </div>
  </div>
</div>

<header class="glass-header">
  <div class="flex items-center">
    <div class="logo font-black text-2xl tracking-tighter mr-10">UNDERSOUTHERN</div>
    <nav class="flex gap-10 text-[11px] font-black uppercase tracking-[0.2em] text-slate-400">
      <a href="#" class="text-black border-b-2 border-black pb-1">Master Catalog</a>
    </nav>
  </div>
  <div class="flex items-center gap-8">
    <div id="admBadge" class="hidden flex items-center gap-2 bg-rose-600 text-white pl-2 pr-4 py-1.5 rounded-full text-[10px] font-black uppercase italic tracking-tighter">
      <i class="fa-solid fa-crown text-[8px]"></i> Root Admin
    </div>
    <div class="flex items-center gap-4 group cursor-pointer">
       <div class="text-right">
         <div id="userNameDisp" class="text-sm font-black tracking-tight leading-none">-</div>
         <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">Active Session</div>
       </div>
       <div class="w-11 h-11 rounded-2xl bg-black shadow-lg ring-4 ring-white overflow-hidden" id="userAvatar"></div>
    </div>
  </div>
</header>

<main class="main-container">
  
  <div id="viewList" class="fade-in">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12" id="adminAnalytics">
      <div class="analytic-card py-6 flex items-center gap-5">
        <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-xl"><i class="fa-solid fa-layer-group"></i></div>
        <div><div id="countAll" class="text-2xl font-black">0</div><div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Assets</div></div>
      </div>
      <div class="analytic-card py-6 flex items-center gap-5">
        <div class="w-12 h-12 bg-amber-50 text-amber-600 rounded-2xl flex items-center justify-center text-xl"><i class="fa-solid fa-clock-rotate-left"></i></div>
        <div><div id="countPending" class="text-2xl font-black">0</div><div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Pending Review</div></div>
      </div>
      <div class="analytic-card py-6 flex items-center gap-5">
        <div class="w-12 h-12 bg-green-50 text-green-600 rounded-2xl flex items-center justify-center text-xl"><i class="fa-solid fa-check-double"></i></div>
        <div><div id="countReleased" class="text-2xl font-black">0</div><div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Distributed</div></div>
      </div>
      <div class="analytic-card py-6 flex items-center gap-5 border-rose-100 bg-rose-50/30">
        <div class="w-12 h-12 bg-rose-100 text-rose-600 rounded-2xl flex items-center justify-center text-xl"><i class="fa-solid fa-circle-exclamation"></i></div>
        <div><div id="countRejected" class="text-2xl font-black">0</div><div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Rejected Items</div></div>
      </div>
    </div>

    <div class="flex justify-between items-end mb-10">
      <div>
        <h1 class="text-5xl font-black tracking-tighter">Catalog Overview</h1>
        <p class="text-sm font-bold text-slate-400 mt-2">Manage your music distribution lifecycle.</p>
      </div>
      <button class="btn-analytics btn-primary-dark shadow-2xl shadow-slate-300" onclick="openAddForm()">
        <i class="fa-solid fa-plus-circle"></i> Create New Release
      </button>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr>
            <th>Type</th>
            <th>Status</th>
            <th>Asset Metadata</th>
            <th>Catalog Label</th>
            <th>Items</th>
            <th>Identifier</th>
            <th class="text-right">Control</th>
          </tr>
        </thead>
        <tbody id="catalogTable"></tbody>
      </table>
    </div>
  </div>

  <div id="viewForm" class="hidden fade-in">
    <div class="flex justify-between items-center mb-12">
      <div class="flex items-center gap-6">
        <button class="w-14 h-14 bg-white border border-slate-200 rounded-3xl flex items-center justify-center hover:bg-slate-50 shadow-sm transition" onclick="toggleView('list')">
          <i class="fa-solid fa-chevron-left text-lg"></i>
        </button>
        <div>
           <h2 id="fTitleHead" class="text-4xl font-black tracking-tighter">Metadata Submission</h2>
           <p class="text-xs font-bold text-slate-400 uppercase tracking-[0.2em] mt-2">Legal Asset Management System</p>
        </div>
      </div>
      <div id="fStatusTagTop"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 items-start">
      
      <div class="analytic-card">
        <h3><i class="fa-solid fa-palette"></i> Visual Media</h3>
        <div class="input-group">
          <label>High-Res Cover Artwork</label>
          <div class="artwork-uploader shadow-inner" id="artZone" onclick="document.getElementById('artInput').click()">
            <img id="artPrev" src="">
            <i class="fa-solid fa-image"></i>
            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">3000x3000px JPG</span>
            <input type="file" id="artInput" hidden accept="image/*" onchange="handleArtwork(this)">
          </div>
        </div>
        <div class="mt-10 input-group">
          <label>Primary Release Title</label>
          <input type="text" id="fTitleInput" class="input-field" placeholder="Moonlight">
          <label>Artist Metadata</label>
          <div id="fArtistTags" class="flex flex-wrap gap-2 mb-4"></div>
          <input type="text" id="fArtistInput" class="input-field" placeholder="Add artist and Enter">
          <label>Label</label>
          <input type="text" id="fLabel" class="input-field" value="UNDERSOUTHERN">
        </div>
      </div>

      <div class="analytic-card">
        <h3><i class="fa-solid fa-barcode"></i> Global Identifiers</h3>
        <div class="input-group">
          <label>Distribution Format</label>
          <select id="fType" class="input-field font-bold"><option>Single</option><option>EP</option><option>Album</option></select>
          <div class="grid grid-cols-2 gap-5">
            <div><label>Release Date</label><input type="date" id="fDate" class="input-field font-bold"></div>
            <div><label>Hour (UTC)</label><input type="time" id="fHour" class="input-field font-bold"></div>
          </div>
          <label>UPC / EAN</label>
          <input type="text" id="fUPC" class="input-field font-mono" placeholder="Auto-gen">
          <label>Internal Catalog ID</label>
          <input type="text" id="fCat" class="input-field font-mono" value="US-001">
        </div>

        <div id="admControlZone" class="hidden mt-10 p-8 bg-slate-900 rounded-[32px] border-4 border-slate-800 shadow-2xl">
          <div class="flex items-center gap-3 mb-8">
            <div class="w-8 h-8 bg-rose-500 text-white rounded-xl flex items-center justify-center"><i class="fa-solid fa-shield-halved text-xs"></i></div>
            <h3 class="text-white m-0 tracking-widest uppercase text-xs">Root Administration</h3>
          </div>
          <div class="input-group">
            <label class="text-slate-400">Override Asset Status</label>
            <select id="admStatus" class="input-field bg-slate-800 border-slate-700 text-white" onchange="toggleAdmRejectBox()">
              <option value="Draft">Draft</option>
              <option value="Pending">Pending Review</option>
              <option value="Released">Released (Approve)</option>
              <option value="Rejected">Rejected</option>
            </select>
            <div id="admRejectZone" class="hidden mt-6">
              <label class="text-rose-400">Specify Rejection Reason</label>
              <textarea id="admReason" class="input-field bg-slate-800 border-slate-700 text-white h-24 text-xs font-medium"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="analytic-card">
        <h3><i class="fa-solid fa-earth-americas"></i> Rights & Regions</h3>
        <div class="input-group">
          <label>Territory Delivery</label>
          <div id="fTerritoryTags" class="flex flex-wrap gap-2 mb-4"></div>
          <input type="text" id="fTerritoryInput" class="input-field" placeholder="e.g. Vietnam, USA">
        </div>
        
        <div class="mt-14 p-8 bg-slate-50 rounded-[32px] border border-slate-100 shadow-inner">
          <label class="text-slate-400">Internal Workflow Stage</label>
          <div id="fStatusDispText" class="text-4xl font-black uppercase tracking-tighter text-slate-900">-</div>
          <div id="fRejectLog" class="text-[11px] text-rose-600 mt-6 font-bold bg-white p-5 rounded-2xl border border-rose-50 hidden leading-relaxed"></div>
        </div>
      </div>

      <div class="analytic-card lg:col-span-3">
        <div class="flex justify-between items-center mb-10">
          <h3 class="m-0"><i class="fa-solid fa-list-check"></i> Track Metadata Matrix</h3>
          <div id="fTrackCounter" class="bg-slate-900 text-white text-[10px] font-black px-5 py-2 rounded-full tracking-widest uppercase">0 Audio Units</div>
        </div>
        <div id="tracks-container"></div>
        <button id="addTrackBtn" class="w-full py-8 border-2 border-dashed border-slate-200 rounded-[32px] text-[11px] font-black text-slate-400 hover:border-black hover:text-black hover:bg-slate-50 transition uppercase tracking-[0.3em]" onclick="addNewRow()">
          <i class="fa-solid fa-plus-circle mr-2 text-sm"></i> Add Component
        </button>
      </div>
    </div>

    <div class="flex justify-between items-center mt-12 pt-10 border-t border-slate-200">
      <button id="btnDelete" class="btn-analytics bg-rose-50 text-rose-600 hidden hover:bg-rose-600 hover:text-white" onclick="prepAction('delete')">
        <i class="fa-solid fa-trash-can text-sm"></i> Wipe Record
      </button>
      <div class="flex gap-6 ml-auto">
        <button id="btnSave" class="btn-analytics bg-slate-100 text-slate-600 hover:bg-slate-200" onclick="prepAction('save_draft')">Save Sync</button>
        <button id="btnSubmit" class="btn-analytics btn-primary-dark shadow-2xl shadow-slate-300" onclick="prepAction('submit')">Submit Distribution</button>
      </div>
    </div>
  </div>
</main>

<script>
  /* --- MASTER LOGIC (700+ LINES CAPABILITY) --- */
  const FB_NODE = "https://undersouthern-system-default-rtdb.asia-southeast1.firebasedatabase.app/catalog";
  const sessionUser = localStorage.getItem('activeUser') || 'Unauthorized';
  const rootAdmin = (sessionUser === 'UNDERSOUTHERN');

  let activeId = null;
  let flowAction = '';
  let metaArtists = [];
  let metaRegions = [];
  let artworkStream = "";
  let masterDB = {};

  window.onload = async () => {
    document.getElementById('userNameDisp').innerText = sessionUser;
    const avt = localStorage.getItem('userAvatar');
    if(avt) document.getElementById('userAvatar').innerHTML = `<img src="${avt}" class="w-full h-full object-cover">`;
    if(rootAdmin) document.getElementById('admBadge').classList.remove('hidden');
    
    bindTagEvents();
    await syncCoreData();
  };

  async function syncCoreData() {
    try {
      const res = await fetch(`${FB_NODE}.json`);
      masterDB = await res.json() || {};
      renderMasterList();
      computeAnalytics();
    } catch(err) { console.error("Critical Sync Failure"); }
  }

  function computeAnalytics() {
    const arr = Object.values(masterDB);
    document.getElementById('countAll').innerText = arr.length;
    document.getElementById('countPending').innerText = arr.filter(i=>i.status==='Pending').length;
    document.getElementById('countReleased').innerText = arr.filter(i=>i.status==='Released').length;
    document.getElementById('countRejected').innerText = arr.filter(i=>i.status==='Rejected').length;
  }

  function bindTagEvents() {
    const hook = (id, list, render) => {
      const el = document.getElementById(id);
      el.onkeydown = (e) => {
        if(e.key === 'Enter' && el.value.trim()){
          e.preventDefault(); list.push(el.value.trim()); el.value=''; render();
        }
      };
    };
    hook('fArtistInput', metaArtists, renderArtists);
    hook('fTerritoryInput', metaRegions, renderRegions);
  }

  function renderArtists() {
    document.getElementById('fArtistTags').innerHTML = metaArtists.map((a,i)=>`<div class="badge bg-black text-white flex items-center gap-2">${a} <i class="fa-solid fa-xmark cursor-pointer opacity-50 hover:opacity-100" onclick="metaArtists.splice(${i},1);renderArtists()"></i></div>`).join('');
  }
  function renderRegions() {
    document.getElementById('fTerritoryTags').innerHTML = metaRegions.map((t,i)=>`<div class="badge bg-slate-100 text-slate-500 flex items-center gap-2">${t} <i class="fa-solid fa-xmark cursor-pointer opacity-50 hover:opacity-100" onclick="metaRegions.splice(${i},1);renderRegions()"></i></div>`).join('');
  }

  function handleArtwork(input) {
    if(input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('artPrev').src = e.target.result;
        document.getElementById('artPrev').style.display = 'block';
        artworkStream = e.target.result;
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function addNewRow(data = {}) {
    const box = document.getElementById('tracks-container');
    const div = document.createElement('div');
    div.className = 'track-row fade-in';
    const index = box.children.length + 1;
    div.innerHTML = `
      <div class="font-black text-slate-200">#${index}</div>
      <input type="text" class="tr-title input-field" placeholder="Official Track Title" value="${data.title || ''}">
      <input type="text" class="tr-isrc input-field font-mono text-[11px]" placeholder="ISRC (Auto-assign)" value="${data.isrc || ''}">
      <div class="text-[9px] font-black text-slate-400 bg-white border border-slate-100 p-3 rounded-2xl text-center uppercase tracking-tighter shadow-sm">Audio Node: NIL</div>
      <button class="w-10 h-10 flex items-center justify-center text-slate-200 hover:text-rose-500 transition" onclick="this.parentElement.remove();refreshCounter()">
        <i class="fa-solid fa-circle-xmark text-xl"></i>
      </button>
    `;
    box.appendChild(div);
    refreshCounter();
  }

  function refreshCounter() {
    const c = document.getElementById('tracks-container').children.length;
    document.getElementById('fTrackCounter').innerText = `${c} AUDIO COMPONENT${c>1?'S':''}`;
  }

  function renderMasterList() {
    const list = document.getElementById('catalogTable');
    const dataArr = Object.keys(masterDB).map(k => ({id:k, ...masterDB[k]}));
    const filtered = rootAdmin ? dataArr : dataArr.filter(i => i.owner === sessionUser);
    
    list.innerHTML = filtered.map(i => `
      <tr class="fade-in">
        <td><b class="text-slate-900">${i.type}</b></td>
        <td><span class="badge badge-${i.status.toLowerCase()}">${i.status}</span></td>
        <td>
          <div class="flex items-center gap-4">
            <img src="${i.artwork || 'https://via.placeholder.com/80'}" class="w-14 h-14 rounded-2xl object-cover border border-slate-100 shadow-sm">
            <div>
              <div class="font-black text-slate-900 text-base tracking-tight">${i.title}</div>
              <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">${i.artists?.join(' • ')}</div>
            </div>
          </div>
        </td>
        <td class="font-bold text-slate-500 italic">${i.label || 'UNDERSOUTHERN'}</td>
        <td><span class="bg-slate-900 text-white px-3 py-1 rounded-lg font-black text-[9px]">${i.tracks?.length || 0} UNI</span></td>
        <td class="font-mono text-[11px] text-slate-400 font-bold tracking-tighter">${i.upc || 'PENDING'}</td>
        <td class="text-right">
          <button class="w-12 h-12 rounded-2xl bg-slate-50 border border-slate-200 text-slate-400 hover:text-black hover:border-black hover:bg-white transition flex items-center justify-center ml-auto shadow-sm" onclick="fetchItemToEdit('${i.id}')">
            <i class="fa-solid fa-arrow-right"></i>
          </button>
        </td>
      </tr>
    `).join('');
  }

  function prepAction(type) {
    flowAction = type;
    const tit = document.getElementById('fTitleInput').value;
    if(type !== 'delete' && (!tit || metaArtists.length === 0 || !artworkStream)) return alert("Asset Integrity Error: Artwork, Title, and Artists are required.");

    const modTit = document.getElementById('mTitle');
    const modDesc = document.getElementById('mDesc');
    
    modTit.innerText = type === 'delete' ? "Wipe Asset Record" : (type === 'submit' ? "Submit Distribution" : "Process Synchronization");
    document.getElementById('mRejectContainer').classList.add('hidden');
    document.getElementById('mCheck').checked = false;
    validateModal();
    document.getElementById('actionModal').style.display = 'flex';
  }

  async function executeFinalAction() {
    if(flowAction === 'delete') {
      await fetch(`${FB_NODE}/${activeId}.json`, { method: 'DELETE' });
    } else {
      let status = rootAdmin ? document.getElementById('admStatus').value : (flowAction === 'submit' ? 'Pending' : 'Draft');
      const tracksMeta = Array.from(document.querySelectorAll('.track-row')).map((row, idx) => ({
        title: row.querySelector('.tr-title').value,
        isrc: row.querySelector('.tr-isrc').value || `US-H12-${new Date().getFullYear()}-${1000 + idx}`
      }));

      const payload = {
        title: document.getElementById('fTitleInput').value,
        artists: metaArtists, artwork: artworkStream, type: document.getElementById('fType').value,
        label: document.getElementById('fLabel').value || 'UNDERSOUTHERN',
        date: document.getElementById('fDate').value, hour: document.getElementById('fHour').value,
        upc: document.getElementById('fUPC').value || `840${Math.floor(100000000 + Math.random()*900000000)}`,
        catNum: document.getElementById('fCat').value,
        status: status, owner: activeId ? masterDB[activeId].owner : sessionUser,
        tracks: tracksMeta, territories: metaRegions,
        rejectReason: rootAdmin && status === 'Rejected' ? document.getElementById('admReason').value : (activeId ? masterDB[activeId].rejectReason : ""),
        timestamp: new Date().getTime()
      };
      
      await fetch(activeId ? `${FB_NODE}/${activeId}.json` : `${FB_NODE}.json`, { 
        method: activeId ? 'PATCH' : 'POST', 
        body: JSON.stringify(payload) 
      });
    }
    await syncCoreData();
    closeModal();
    toggleView('list');
  }

  function fetchItemToEdit(id) {
    activeId = id;
    const it = masterDB[id];
    document.getElementById('fTitleInput').value = it.title;
    document.getElementById('fType').value = it.type;
    document.getElementById('fUPC').value = it.upc || '';
    document.getElementById('fDate').value = it.date || '';
    document.getElementById('fHour').value = it.hour || '';
    document.getElementById('fLabel').value = it.label || 'UNDERSOUTHERN';
    document.getElementById('fCat').value = it.catNum || '';
    metaArtists = it.artists || [];
    metaRegions = it.territories || [];
    artworkStream = it.artwork || "";
    document.getElementById('artPrev').src = artworkStream;
    document.getElementById('artPrev').style.display = artworkStream ? 'block' : 'none';
    
    document.getElementById('fStatusDispText').innerText = it.status;
    const rejectLog = document.getElementById('fRejectLog');
    if(it.rejectReason) { rejectLog.innerText = `ADMIN LOG: ${it.rejectReason}`; rejectLog.classList.remove('hidden'); }
    else rejectLog.classList.add('hidden');

    document.getElementById('btnDelete').classList.toggle('hidden', !rootAdmin);

    if(rootAdmin) {
      document.getElementById('admControlZone').classList.remove('hidden');
      document.getElementById('admStatus').value = it.status;
      document.getElementById('admReason').value = it.rejectReason || "";
      toggleAdmRejectBox();
      grantEditAccess(true);
    } else {
      document.getElementById('admControlZone').classList.add('hidden');
      grantEditAccess(it.status === 'Draft' || it.status === 'Rejected');
    }

    document.getElementById('tracks-container').innerHTML = '';
    if(it.tracks) it.tracks.forEach(t => addNewRow(t));
    renderArtists(); renderRegions(); toggleView('form');
  }

  function grantEditAccess(canEdit) {
    document.querySelectorAll('#viewForm .input-field').forEach(inp => {
      if(!inp.closest('#admControlZone')) inp.disabled = !canEdit;
    });
    document.getElementById('btnSave').classList.toggle('hidden', !canEdit);
    document.getElementById('btnSubmit').classList.toggle('hidden', !canEdit);
    document.getElementById('addTrackBtn').classList.toggle('hidden', !canEdit);
    document.getElementById('artZone').style.pointerEvents = canEdit ? 'auto' : 'none';
  }

  function openAddForm() {
    activeId = null; metaArtists = []; metaRegions = []; artworkStream = "";
    document.getElementById('artPrev').style.display = 'none';
    document.getElementById('tracks-container').innerHTML = '';
    document.getElementById('fStatusDispText').innerText = "NEW ASSET";
    document.getElementById('fRejectLog').classList.add('hidden');
    document.getElementById('admControlZone').classList.add('hidden');
    document.getElementById('btnDelete').classList.add('hidden');
    grantEditAccess(true);
    addNewRow(); 
    toggleView('form');
  }

  function toggleView(v) {
    document.getElementById('viewList').classList.toggle('hidden', v === 'form');
    document.getElementById('viewForm').classList.toggle('hidden', v === 'list');
    if(v==='list') syncCoreData();
  }
  function closeModal() { document.getElementById('actionModal').style.display = 'none'; }
  function toggleModalCheck() { document.getElementById('mCheck').checked = !document.getElementById('mCheck').checked; validateModal(); }
  function validateModal() { document.getElementById('mConfirmBtn').disabled = !document.getElementById('mCheck').checked; document.getElementById('mConfirmBtn').classList.toggle('opacity-20', !document.getElementById('mCheck').checked); }
  function toggleAdmRejectBox() { document.getElementById('admRejectZone').classList.toggle('hidden', document.getElementById('admStatus').value !== 'Rejected'); }
</script>
</body>
</html>
