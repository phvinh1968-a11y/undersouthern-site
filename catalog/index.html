<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Catalog Management - UNDERSOUTHERN</title>

<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/phvinh1968-a11y/my-images/main/logoblack.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
    /* KIỂM TRA ĐĂNG NHẬP NGAY LẬP TỨC TRƯỚC KHI TẢI CSS/BODY */
    if (localStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = "https://undersouthern.asia/login";
    }
</script>

<style>
  :root {
    --bg-body: #ffffff;
    --primary-black: #000000;
    --text-muted: #666666;
    --border-color: #eeeeee;
    --hover-bg: #f5f5f5;
    --radius-main: 10px;
    --font-main: 'Inter', sans-serif;
    --header-height: 72px;
  }

  /* Ẩn nội dung để bảo mật trước khi script xác thực chạy xong */
  #auth-guard { display: none; }

  body { font-family: var(--font-main); background-color: var(--bg-body); margin: 0; padding: 0; letter-spacing: -0.01em; }

  /* --- HIỆU ỨNG LOAD CHẬM --- */
  .fade-item { opacity: 0; transform: translateY(10px); transition: opacity 0.6s ease, transform 0.6s ease; }
  .fade-item.show { opacity: 1; transform: translateY(0); }

  /* --- HEADER --- */
  .main-header {
    height: var(--header-height); border-bottom: 1px solid var(--border-color);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 40px; position: sticky; top: 0; background: #fff; z-index: 1000;
  }
  .brand-name { font-weight: 900; font-size: 20px; letter-spacing: -0.05em; text-transform: uppercase; margin: 0; padding-right: 40px; border-right: 1px solid var(--border-color); height: 100%; display: flex; align-items: center; }
  .user-avatar-circle { width: 32px; height: 32px; background: var(--primary-black); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 10px; font-weight: 700; cursor: pointer; overflow: hidden; }
  .user-avatar-circle img { width: 100%; height: 100%; object-fit: cover; }

  /* --- LAYOUT --- */
  .layout-wrapper { max-width: 1600px; margin: 0 auto; padding: 40px 20px; }
  .hidden { display: none !important; }

  .card { background: #fff; padding: 24px; border-radius: var(--radius-main); border: 1px solid var(--border-color); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
  h3 { font-size: 13px; text-transform: uppercase; margin: 0 0 20px 0; font-weight: 700; }
  label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #444; }
  input, select, textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px; box-sizing: border-box; margin-bottom: 15px; background: #fff; }
  input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-black); }

  .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
  .btn-primary { background: var(--primary-black); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
  
  /* --- BẢNG CATALOG --- */
  .table-container { border: 1px solid var(--border-color); border-radius: var(--radius-main); overflow-x: auto; background: #fff; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 1200px; }
  th { background: #fafafa; text-align: left; padding: 14px; color: var(--text-muted); font-size: 10px; text-transform: uppercase; border-bottom: 1px solid var(--border-color); }
  td { padding: 14px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
  
  .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
  .st-released { background: #e6f9f0; color: #16a34a; }
  .st-pending { background: #fff7ed; color: #ea580c; }
  .st-draft { background: #f1f5f9; color: #64748b; }
  .st-rejected { background: #fef2f2; color: #dc2626; }

  .release-title { font-weight: 700; color: #000; display: block; }
  .release-artist { font-size: 12px; color: #666; }
  .upc-code { font-family: monospace; color: #888; font-size: 11px; }

  /* --- MODAL TAKEDOWN / ACTION --- */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(4px); }
  .modal-box { background: white; padding: 32px; border-radius: 20px; width: 450px; text-align: left; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
  .modal-box h2 { font-size: 20px; font-weight: 800; margin: 0 0 15px 0; color: #000; }
  .modal-box p { font-size: 13.5px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; }
  
  .takedown-confirm-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 12px; align-items: flex-start; cursor: pointer; }
  .takedown-confirm-box input { width: 18px; height: 18px; margin: 0; margin-top: 2px; cursor: pointer; accent-color: #000; }
  .takedown-confirm-box label { font-size: 13px; font-weight: 500; color: #000; line-height: 1.4; margin: 0; cursor: pointer; }

  .btn-modal-cancel { border: 1px solid #ddd; padding: 12px 24px; border-radius: 8px; cursor: pointer; background: white; font-weight: 600; font-size: 14px; flex: 1; }
  .btn-modal-takedown { background: #000; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; flex: 1; opacity: 0.3; pointer-events: none; transition: 0.3s; }
  .btn-modal-takedown.active { opacity: 1; pointer-events: auto; }

  /* --- TAGS --- */
  .tag-container { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
  .tag { background: #000; color: #fff; padding: 3px 8px; border-radius: 6px; font-size: 11px; display: flex; align-items: center; gap: 5px; font-weight: 500; }
  .tag i { cursor: pointer; color: #fff; font-size: 10px; opacity: 0.7; }

  .form-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; }
  .footer-actions { display: flex; justify-content: flex-end; margin-top: 40px; }
  .save-btn { background: var(--primary-black); color: white; border: none; padding: 12px 40px; font-weight: 700; border-radius: 8px; cursor: pointer; }

  /* --- TRACKLIST --- */
  .tracklist-card { grid-column: span 3; margin-top: 10px; border-top: 2px solid #000; padding-top: 20px; }
  .track-row { display: grid; grid-template-columns: 30px 1.5fr 1fr 1.5fr 1.5fr 1.2fr 1.2fr 30px; gap: 10px; align-items: center; background: #f9f9f9; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee; }
  .track-row input { margin-bottom: 0; font-size: 11px; }
  .audio-upload-btn { background: #fff; border: 1px solid #ddd; padding: 6px; border-radius: 6px; font-size: 10px; cursor: pointer; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .btn-add-track { background: #fff; border: 1px dashed #000; padding: 10px; width: 100%; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; }

  tbody tr { opacity: 0; transform: translateY(5px); transition: 0.5s ease; }
  tbody tr.loaded { opacity: 1; transform: translateY(0); }
  .btn-icon { border: 1px solid var(--border-color); background: #fff; padding: 6px 10px; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
  .btn-icon:hover { background: var(--hover-bg); }

  /* Thêm màu cho lý do Reject */
  .reject-text { font-size: 11px; color: #ef4444; margin-top: 4px; font-weight: 500; }
</style>
</head>
<body>

<div id="auth-guard">
    <div class="modal-overlay" id="takedownModal">
      <div class="modal-box">
        <h2 id="modalTitle">Takedown release</h2>
        <p id="modalDesc">Why are you removing this release?</p>
        <textarea id="takedownReason" rows="3" placeholder="Please provide a reason..."></textarea>
        <div class="takedown-confirm-box" id="confirmBox" onclick="toggleTakedownCheckbox()">
          <input type="checkbox" id="confirmTakedownCheck" onchange="validateTakedown()">
          <label for="confirmTakedownCheck">
            Yes, I'm sure I want to proceed with this action.
          </label>
        </div>
        <p id="takedownWarning" style="font-size: 12px; background: #fff7ed; color: #9a3412; padding: 12px; border-radius: 8px; border: 1px solid #ffedd5;">
          This action will update the status of the release across the system.
        </p>
        <div style="display:flex; gap:12px; margin-top: 25px;">
          <button class="btn-modal-cancel" onclick="closeModal()">Cancel</button>
          <button class="btn-modal-takedown" id="takedownBtn" onclick="executeAction()">Confirm</button>
        </div>
      </div>
    </div>

    <header class="main-header fade-item" id="header-el">
      <div class="header-left">
        <h1 class="brand-name">UNDERSOUTHERN</h1>
      </div>
      <div class="header-right">
        <div class="user-avatar-circle" id="userAvatar">
          <span id="avatarText">US</span>
        </div>
      </div>
    </header>

    <div class="layout-wrapper">
      <div id="view-list">
        <div class="top-bar fade-item" id="top-bar-el">
          <div class="title-group" style="display:flex; align-items:center; gap:15px;">
            <button class="btn-icon" onclick="window.location.href='https://undersouthern.asia/dashboard'">
              <i class="fa-solid fa-arrow-left"></i>
            </button>
            <h2 style="margin:0; font-weight:700">Release Catalog</h2>
          </div>
          <button class="btn-primary" onclick="openAddForm()">
            <i class="fa-solid fa-plus"></i> Create New Release
          </button>
        </div>

        <div class="table-container fade-item" id="table-el">
          <table>
            <thead>
              <tr>
                <th>Type</th>
                <th>Status</th>
                <th>Title / Artist</th>
                <th>Label</th>
                <th>Release Info</th>
                <th># Tracks</th>
                <th>UPC / Cat #</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="catalogTableBody"></tbody>
          </table>
        </div>
      </div>

      <div id="view-add" class="hidden">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
          <button class="btn-icon" onclick="toggleView('list')"><i class="fa-solid fa-arrow-left"></i></button>
          <h2 id="formTitle" style="margin:0; font-weight:700">New Release</h2>
        </div>
        <div class="form-container">
          <div class="card">
            <h3>Release Info</h3>
            <label>Type</label>
            <select id="inType" onchange="toggleTracklist()">
              <option value="Single">Single</option>
              <option value="EP">EP</option>
              <option value="Album">Album</option>
            </select>
            <label>Title</label><input type="text" id="inTitle" placeholder="Moonlight">
            
            <label>Primary Artist(s)</label>
            <div id="main-artist-tags" class="tag-container"></div>
            <input type="text" id="inMainArtist" placeholder="Add artist and Enter">

            <label>Label</label><input type="text" id="inLabel" placeholder="UNDERSOUTHERN">
          </div>
          <div class="card">
            <h3>Schedule & ID</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div><label>Date</label><input type="date" id="inDate"></div>
              <div><label>Hour</label><input type="time" id="inHour"></div>
            </div>
            <label>UPC Code</label><input type="text" id="inUPC" placeholder="Auto-gen if empty">
            <label>Catalog Number</label><input type="text" id="inCatNum" placeholder="US-001">
          </div>
          <div class="card">
            <h3>Distribution</h3>
            <label>Delivered Territories</label>
            <div id="territory-tags" class="tag-container"></div>
            <input type="text" id="territoryInput" placeholder="Add country and Enter">
            
            <div id="statusWrapper" class="hidden">
              <label>Status</label>
              <select id="inStatus">
                <option value="Draft">Draft</option>
                <option value="Pending">Pending</option>
                <option value="Released">Released</option>
                <option value="Rejected">Rejected</option>
              </select>
            </div>
          </div>

          <div class="card tracklist-card">
            <h3>Tracklist Configuration</h3>
            <div id="track-header" class="track-row" style="background:none; border:none; font-weight:700; font-size:9px; color:#666; text-transform:uppercase;">
                <div>#</div><div>Title</div><div>Version</div><div>Primary Artists</div><div>Feats</div><div>ISRC</div><div>Audio</div><div></div>
            </div>
            <div id="tracks-container"></div>
            <button class="btn-add-track" id="addTrackBtn" onclick="addTrackRow()">+ Add New Track</button>
          </div>
        </div>
        <div class="footer-actions">
          <button id="submitBtn" class="save-btn" onclick="handleSave()">Save Release</button>
        </div>
      </div>
    </div>
</div>

<script>
  const DB_URL = "https://undersouthern-system-default-rtdb.asia-southeast1.firebasedatabase.app/catalog";
  const currentUser = localStorage.getItem('activeUser');
  const isAdmin = (currentUser === 'UNDERSOUTHERN');

  let editingKey = null;
  let pendingActionKey = null;
  let currentAction = ''; 
  let territoryList = [];
  let mainArtists = [];
  let firebaseCatalog = {};

  window.onload = async () => {
    if (localStorage.getItem('isLoggedIn') === 'true') {
        document.getElementById('auth-guard').style.display = 'block';
        syncAvatar(); 
        setupTagInputs();
        await syncFromCloud();
        slowLoadView();
    }
  };

  async function syncFromCloud() {
    try {
        const res = await fetch(`${DB_URL}.json`);
        firebaseCatalog = await res.json() || {};
        renderCatalog();
    } catch (e) { console.error("Cloud Error"); }
  }

  function generateUPC() { return "840" + Math.floor(100000000 + Math.random() * 900000000); }
  function generateISRC() { return "US-S12-" + new Date().getFullYear().toString().slice(-2) + "-" + Math.floor(10000 + Math.random() * 90000); }

  function setupTagInputs() {
    const tInp = document.getElementById('territoryInput');
    tInp.onkeydown = (e) => { if(e.key==='Enter' && tInp.value.trim()){ e.preventDefault(); territoryList.push(tInp.value.trim()); tInp.value=''; renderTags(); } };
    const aInp = document.getElementById('inMainArtist');
    aInp.onkeydown = (e) => { if(e.key==='Enter' && aInp.value.trim()){ e.preventDefault(); mainArtists.push(aInp.value.trim()); aInp.value=''; renderMainArtistTags(); } };
  }

  function renderTags() {
    document.getElementById('territory-tags').innerHTML = territoryList.map((t, i) => `<div class="tag">${t} <i class="fa-solid fa-xmark" onclick="territoryList.splice(${i},1);renderTags()"></i></div>`).join('');
  }

  function renderMainArtistTags() {
    document.getElementById('main-artist-tags').innerHTML = mainArtists.map((a, i) => `<div class="tag">${a} <i class="fa-solid fa-xmark" onclick="mainArtists.splice(${i},1);renderMainArtistTags()"></i></div>`).join('');
  }

  let trackCount = 0;
  function addTrackRow(data = {}) {
    trackCount++;
    const container = document.getElementById('tracks-container');
    const row = document.createElement('div');
    row.className = 'track-row'; row.id = `track-row-${trackCount}`;
    row.artists = data.artists || [];
    row.feats = data.feats || [];
    row.innerHTML = `
        <div style="font-weight:700;">${trackCount}</div>
        <input type="text" class="t-title" placeholder="Title" value="${data.title || ''}">
        <input type="text" class="t-version" placeholder="Mix" value="${data.version || ''}">
        <div><div id="tr-art-${trackCount}" class="tag-container"></div><input type="text" class="tr-art-in" placeholder="+ Enter"></div>
        <div><div id="tr-feat-${trackCount}" class="tag-container"></div><input type="text" class="tr-feat-in" placeholder="+ Enter"></div>
        <input type="text" class="t-isrc" placeholder="Auto" value="${data.isrc || ''}">
        <div class="audio-col"><button class="audio-upload-btn" id="audio-btn-${trackCount}" onclick="triggerAudio(${trackCount})">${data.audioName || 'Upload WAV'}</button><input type="file" id="audio-input-${trackCount}" hidden accept=".wav,.flac" onchange="handleAudioSelect(${trackCount})"></div>
        <i class="fa-solid fa-trash" style="cursor:pointer; color:#ff4d4d" onclick="removeTrackRow(${trackCount})"></i>
    `;
    container.appendChild(row);
    const artIn = row.querySelector('.tr-art-in');
    const featIn = row.querySelector('.tr-feat-in');
    const trRenderArt = () => { document.getElementById(`tr-art-${row.id.split('-')[2]}`).innerHTML = row.artists.map((a,i)=>`<div class="tag" style="font-size:8px">${a} <i class="fa-solid fa-xmark" onclick="removeTrackTag('${row.id}', 'artists', ${i})"></i></div>`).join(''); };
    const trRenderFeat = () => { document.getElementById(`tr-feat-${row.id.split('-')[2]}`).innerHTML = row.feats.map((a,i)=>`<div class="tag" style="font-size:8px">${a} <i class="fa-solid fa-xmark" onclick="removeTrackTag('${row.id}', 'feats', ${i})"></i></div>`).join(''); };
    artIn.onkeydown = (e) => { if(e.key==='Enter' && artIn.value.trim()){ e.preventDefault(); row.artists.push(artIn.value.trim()); artIn.value=''; trRenderArt(); } };
    featIn.onkeydown = (e) => { if(e.key==='Enter' && featIn.value.trim()){ e.preventDefault(); row.feats.push(featIn.value.trim()); featIn.value=''; trRenderFeat(); } };
    trRenderArt(); trRenderFeat();
  }

  function removeTrackTag(rowId, type, index) {
    const row = document.getElementById(rowId);
    row[type].splice(index, 1);
    const trackNum = rowId.split('-')[2];
    const containerId = type === 'artists' ? `tr-art-${trackNum}` : `tr-feat-${trackNum}`;
    document.getElementById(containerId).innerHTML = row[type].map((a,i)=>`<div class="tag" style="font-size:8px">${a} <i class="fa-solid fa-xmark" onclick="removeTrackTag('${rowId}', '${type}', ${i})"></i></div>`).join('');
  }

  function triggerAudio(id) { document.getElementById(`audio-input-${id}`).click(); }
  function handleAudioSelect(id) { const f = document.getElementById(`audio-input-${id}`).files[0]; if(f) document.getElementById(`audio-btn-${id}`).innerText = f.name; }
  function removeTrackRow(id) { if (document.querySelectorAll('.track-row').length > 1) document.getElementById(`track-row-${id}`).remove(); }

  async function handleSave() {
    const title = document.getElementById('inTitle').value;
    if (!title || mainArtists.length === 0) return alert("Title and Artists required.");
    const tracks = Array.from(document.querySelectorAll('.track-row')).map(row => ({
        title: row.querySelector('.t-title').value,
        version: row.querySelector('.t-version').value,
        artists: row.artists,
        feats: row.feats,
        isrc: row.querySelector('.t-isrc').value || generateISRC(),
        audioName: row.querySelector('.audio-upload-btn').innerText
    }));
    const release = {
        title, artists: mainArtists, upc: document.getElementById('inUPC').value || generateUPC(),
        type: document.getElementById('inType').value, label: document.getElementById('inLabel').value,
        catNum: document.getElementById('inCatNum').value, date: document.getElementById('inDate').value || '-',
        hour: document.getElementById('inHour').value, status: editingKey ? document.getElementById('inStatus').value : 'Pending',
        tracks: tracks, numTracks: tracks.length, territories: territoryList, owner: currentUser
    };

    try {
        const method = editingKey ? 'PATCH' : 'POST';
        const url = editingKey ? `${DB_URL}/${editingKey}.json` : `${DB_URL}.json`;
        await fetch(url, { method, body: JSON.stringify(release) });
        await syncFromCloud(); toggleView('list');
    } catch(e) { alert("Save Error"); }
  }

  function renderCatalog() {
    const container = document.getElementById('catalogTableBody');
    const catalogArr = Object.keys(firebaseCatalog).map(key => ({ key, ...firebaseCatalog[key] }));
    
    // Logic: Admin xem tất cả, User chỉ xem của mình
    const filtered = isAdmin ? catalogArr : catalogArr.filter(item => item.owner === currentUser);

    container.innerHTML = filtered.map((item) => `
        <tr>
          <td><b>${item.type}</b></td>
          <td>
            <span class="status-badge st-${item.status.toLowerCase()}">${item.status}</span>
            ${item.rejectReason ? `<div class="reject-text">Reject Reason: ${item.rejectReason}</div>` : ''}
          </td>
          <td><span class="release-title">${item.title}</span><span class="release-artist">${item.artists.join(', ')}</span></td>
          <td>${item.label || '-'}</td>
          <td><b>${item.date}</b><br>${item.hour || '00:00'}</td>
          <td style="text-align:center;">${item.numTracks}</td>
          <td><div class="upc-code">UPC: ${item.upc}<br>CAT: ${item.catNum || '-'}</div></td>
          <td style="display:flex; gap:8px">
            <button class="btn-icon" onclick="editRelease('${item.key}')"><i class="fa-solid fa-pen"></i></button>
            <button class="btn-icon" onclick="openActionModal('${item.key}', '${item.status}')"><i class="fa-solid fa-trash"></i></button>
            ${isAdmin && item.status === 'Pending' ? `
              <button class="btn-icon" style="color:#16a34a" onclick="adminApprove('${item.key}')" title="Approve"><i class="fa-solid fa-check"></i></button>
              <button class="btn-icon" style="color:#dc2626" onclick="openRejectModal('${item.key}')" title="Reject"><i class="fa-solid fa-xmark"></i></button>
            ` : ''}
          </td>
        </tr>
      `).join('');
    container.querySelectorAll('tr').forEach((row, index) => setTimeout(() => row.classList.add('loaded'), index * 100));
  }

  function openActionModal(key, status) {
    pendingActionKey = key;
    if (status === 'Draft' || isAdmin) {
      currentAction = 'delete';
      document.getElementById('modalTitle').innerText = "Delete Release";
      document.getElementById('modalDesc').innerText = "Are you sure you want to permanently delete this release from the system?";
      document.getElementById('confirmBox').style.display = 'none';
      document.getElementById('takedownWarning').style.display = 'none';
      document.getElementById('takedownReason').style.display = 'none';
      document.getElementById('takedownBtn').className = "btn-modal-takedown active";
    } else {
      currentAction = 'takedown';
      document.getElementById('modalTitle').innerText = "Takedown Release";
      document.getElementById('modalDesc').innerText = "Why are you removing this release?";
      document.getElementById('confirmBox').style.display = 'flex';
      document.getElementById('takedownWarning').style.display = 'block';
      document.getElementById('takedownReason').style.display = 'block';
      validateTakedown();
    }
    document.getElementById('takedownModal').style.display = 'flex';
  }

  function openRejectModal(key) {
    pendingActionKey = key;
    currentAction = 'reject';
    document.getElementById('modalTitle').innerText = "Reject Release";
    document.getElementById('modalDesc').innerText = "Please provide the reason for rejection:";
    document.getElementById('confirmBox').style.display = 'flex';
    document.getElementById('takedownWarning').style.display = 'none';
    document.getElementById('takedownReason').style.display = 'block';
    validateTakedown();
    document.getElementById('takedownModal').style.display = 'flex';
  }

  async function adminApprove(key) {
    if(confirm("Duyệt phát hành bản ghi này?")) {
        await fetch(`${DB_URL}/${key}.json`, { method: 'PATCH', body: JSON.stringify({ status: 'Released', rejectReason: null }) });
        await syncFromCloud();
    }
  }

  async function executeAction() {
    try {
        if (currentAction === 'delete') {
            await fetch(`${DB_URL}/${pendingActionKey}.json`, { method: 'DELETE' });
        } else if (currentAction === 'takedown') {
            await fetch(`${DB_URL}/${pendingActionKey}.json`, { method: 'PATCH', body: JSON.stringify({ status: 'Draft' }) });
        } else if (currentAction === 'reject') {
            const reason = document.getElementById('takedownReason').value;
            await fetch(`${DB_URL}/${pendingActionKey}.json`, { method: 'PATCH', body: JSON.stringify({ status: 'Rejected', rejectReason: reason }) });
        }
        await syncFromCloud(); closeModal();
    } catch(e) { alert("Action Error"); }
  }

  function openAddForm() {
    editingKey = null; trackCount = 0; territoryList = []; mainArtists = [];
    document.getElementById('tracks-container').innerHTML = '';
    document.getElementById('statusWrapper').classList.add('hidden');
    document.getElementById('inTitle').value = '';
    document.getElementById('inUPC').value = '';
    addTrackRow(); renderTags(); renderMainArtistTags();
    toggleView('add');
  }

  function editRelease(key) {
    editingKey = key;
    const item = firebaseCatalog[key];
    document.getElementById('inTitle').value = item.title;
    document.getElementById('inType').value = item.type;
    document.getElementById('inLabel').value = item.label;
    document.getElementById('inUPC').value = item.upc;
    document.getElementById('inCatNum').value = item.catNum;
    document.getElementById('inDate').value = item.date;
    document.getElementById('inHour').value = item.hour;
    document.getElementById('inStatus').value = item.status;
    document.getElementById('statusWrapper').classList.remove('hidden');
    mainArtists = [...(item.artists || [])];
    territoryList = [...(item.territories || [])];
    document.getElementById('tracks-container').innerHTML = ''; trackCount = 0;
    item.tracks.forEach(t => addTrackRow(t));
    renderTags(); renderMainArtistTags(); toggleView('add');
  }

  // --- UI HELPERS ---
  function slowLoadView() { ['header-el', 'top-bar-el', 'table-el'].forEach((id, i) => setTimeout(() => document.getElementById(id)?.classList.add('show'), (i + 1) * 200)); }
  function toggleView(v) { document.getElementById('view-list').classList.toggle('hidden', v==='add'); document.getElementById('view-add').classList.toggle('hidden', v==='list'); }
  function syncAvatar() { const img = localStorage.getItem('userAvatar'); if (img) document.getElementById('userAvatar').innerHTML = `<img src="${img}">`; }
  function closeModal() { document.getElementById('takedownModal').style.display = 'none'; document.getElementById('confirmTakedownCheck').checked = false; }
  function toggleTakedownCheckbox() { const c = document.getElementById('confirmTakedownCheck'); c.checked = !c.checked; validateTakedown(); }
  function validateTakedown() { const isChecked = document.getElementById('confirmTakedownCheck').checked; const btn = document.getElementById('takedownBtn'); btn.className = isChecked ? "btn-modal-takedown active" : "btn-modal-takedown"; }
  function toggleTracklist() { const type = document.getElementById('inType').value; document.getElementById('addTrackBtn').style.display = (type === 'Single') ? 'none' : 'block'; }
</script>

</body>
</html>
