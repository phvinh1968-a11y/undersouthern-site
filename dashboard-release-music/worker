export default {
  async fetch(request, env) {
    if (request.method !== "POST") {
      return new Response("Only POST", { status: 405 });
    }

    const formData = await request.formData();

    const data = {
      release_title: formData.get("releaseTitle"),
      version: formData.get("version"),
      artist: formData.get("artist"),
      featuring: formData.get("featuring"),
      composer: formData.get("composer"),
      lyricist: formData.get("lyricist"),
      producer: formData.get("producer"),
      release_type: formData.get("releaseType"),
      release_date: formData.get("releaseDate"),
      genre: formData.get("genre"),
      language: formData.get("language"),
      lyrics: formData.get("lyrics"),
      description: formData.get("description")
    };

    const audio = formData.get("audio");
    const artwork = formData.get("artwork");

    // upload audio
    const audioKey = `audio/${Date.now()}-${audio.name}`;
    await env.R2.put(audioKey, audio.stream());

    // upload artwork
    const artworkKey = `artwork/${Date.now()}-${artwork.name}`;
    await env.R2.put(artworkKey, artwork.stream());

    // gá»­i sang Google Sheet
    await fetch(env.GSHEET_WEBHOOK, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        ...data,
        audio_path: audioKey,
        artwork_path: artworkKey
      })
    });

    return Response.json({ success: true });
  }
};

