<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    
    <title>Account Settings - UNDERSOUTHERN</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/phvinh1968-a11y/my-images/main/logoblack.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #ffffff; 
            color: #000000; 
            margin: 0;
        }
        
        .input-field {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            width: 100%;
            color: #0f172a;
            font-size: 13px;
            font-weight: 500;
            outline: none;
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: #000000;
            background-color: #ffffff;
            box-shadow: 0 0 0 1px #000000;
        }

        .section-title {
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #94a3b8;
            margin-bottom: 20px;
            margin-top: 40px;
        }

        .label-text {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
        }

        .avatar-container {
            width: 150px;
            height: 150px;
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            background-color: #f8fafc;
            transition: all 0.3s ease;
        }
        .avatar-container:hover { border-color: #000000; }
        .avatar-preview { width: 100%; height: 100%; object-fit: cover; display: none; }
        .avatar-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #94a3b8;
            font-size: 10px;
            text-align: center;
            padding: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: #e2e8f0;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #4f46e5; }
        input:checked + .slider:before { transform: translateX(20px); }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-white">

    <main class="max-w-4xl mx-auto p-6 md:p-12 fade-in">
        <div class="mb-10 pt-4">
            <h2 class="text-3xl md:text-4xl font-bold tracking-tight">Account Settings</h2>
            <p class="text-slate-400 text-sm mt-2 font-medium">Manage your account settings.</p>
        </div>

        <form id="profileForm" class="space-y-8" onsubmit="event.preventDefault();">
            <div>
                <h3 class="section-title">Preferences</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                    <label class="label-text">Message Language</label>
                    <div class="md:col-span-2">
                        <select id="userLang" class="input-field cursor-pointer">
                            <option value="English" selected>English</option>
                            <option value="Vietnamese">Vietnamese</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="border-t border-slate-100 pt-4"></div>

            <div>
                <h3 class="section-title">General Information</h3>
                <div class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
                        <label class="label-text pt-2">Profile Avatar</label>
                        <div class="md:col-span-2">
                            <div class="flex flex-col sm:flex-row items-center gap-6">
                                <div class="avatar-container group cursor-pointer" onclick="document.getElementById('avatarInput').click()">
                                    <img id="preview" class="avatar-preview" src="#" alt="Avatar Preview">
                                    <div id="placeholder" class="avatar-placeholder">
                                        <i class="fa-solid fa-camera text-2xl mb-2"></i>
                                        <span class="font-bold uppercase tracking-wider">Upload</span>
                                        <span class="mt-1 opacity-60">150 x 150</span>
                                    </div>
                                    <input type="file" id="avatarInput" hidden accept=".jpg, .jpeg, .png, .jfif" onchange="previewImage(this)">
                                </div>
                                <div class="text-slate-400 text-[11px] leading-relaxed">
                                    <p class="font-bold text-slate-900 uppercase mb-1">Upload Requirements</p>
                                    <p>• Allowed: JPG, JPEG, PNG, JFIF</p>
                                    <p>• Size: 150 x 150 px</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <label class="label-text">Company Name</label>
                        <div class="md:col-span-2">
                            <input type="text" id="companyName" value="" class="input-field" placeholder="Loading...">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <label class="label-text">E-mail Address</label>
                        <div class="md:col-span-2">
                            <input type="email" id="userEmail" value="" class="input-field" placeholder="Loading...">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <label class="label-text">Full Address</label>
                        <div class="md:col-span-2">
                            <input type="text" id="userAddress" value="" class="input-field" placeholder="No address set">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <label class="label-text">General Phone</label>
                        <div class="md:col-span-2">
                            <input type="text" id="userPhone" value="" class="input-field" placeholder="No phone set">
                        </div>
                    </div>
                </div>
            </div>

            <div class="border-t border-slate-100 pt-4"></div>

            <div>
                <h2 class="text-2xl font-bold tracking-tight mb-6">Notifications</h2>
                <div class="border border-slate-200 rounded-xl p-6 space-y-8">
                    <div class="flex items-start justify-between">
                        <div class="max-w-[80%]">
                            <h4 class="font-bold text-sm text-slate-900">Accounts</h4>
                            <p class="text-[13px] text-slate-400 mt-1">Notify me about changes to my accounts, new members, and other related updates.</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="notifAccount" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="flex items-start justify-between">
                        <div class="max-w-[80%]">
                            <h4 class="font-bold text-sm text-slate-900">Distribution</h4>
                            <p class="text-[13px] text-slate-400 mt-1">Notify me about activity related to assets marked for distribution.</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="notifDist" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="flex items-start justify-between">
                        <div class="max-w-[80%]">
                            <h4 class="font-bold text-sm text-slate-900">Statements</h4>
                            <p class="text-[13px] text-slate-400 mt-1">Notify me when new statements are ready to review.</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="notifStat" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="border-t border-slate-100 pt-4"></div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h2 class="text-[16px] font-bold text-slate-900">Your Browser Sessions</h2>
                    <p class="text-[13px] text-slate-500 mt-2 leading-relaxed">Here's all of the browser sessions you've logged into your account.</p>
                </div>
                <div class="md:col-span-2 space-y-6">
                    <div class="bg-slate-50 border border-slate-100 rounded-lg p-4 flex items-start space-x-3">
                        <i class="fa-solid fa-circle-info text-slate-400 mt-1"></i>
                        <div class="text-[13px] text-slate-600 leading-relaxed">
                            <p class="font-bold text-slate-800">Browser Sessions</p>
                            <p class="mt-1">If necessary, you can log out of all other browser sessions across all devices. If you feel your account is compromised, please change your password.</p>
                        </div>
                    </div>

                    <div class="space-y-6 pt-2">
                        <div class="flex items-start space-x-4">
                            <div class="mt-1 text-slate-900">
                                <i class="fa-solid fa-desktop text-xl"></i>
                            </div>
                            <div class="text-[13px]">
                                <div class="flex items-center space-x-2">
                                    <span id="current-browser" class="font-semibold text-slate-900">Chrome</span>
                                    <span class="text-green-500 font-bold text-[11px] uppercase tracking-wide">This device</span>
                                </div>
                                <p class="text-slate-400 mt-0.5"><span id="current-ip">162.159.98.125</span></p>
                            </div>
                        </div>

                        <div class="flex items-start space-x-4 opacity-80">
                            <div class="mt-1 text-slate-900">
                                <i class="fa-solid fa-desktop text-xl"></i>
                            </div>
                            <div class="text-[13px]">
                                <p class="font-semibold text-slate-900">Chrome</p>
                                <p class="text-slate-400 mt-0.5">162.158.88.80, Last Active 1 hour ago</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pt-12 pb-20">
                <button type="button" id="updateBtn" onclick="handleUpdate()" class="w-full md:w-auto min-w-[220px] py-4 bg-black text-white text-[11px] font-bold uppercase tracking-[0.2em] rounded-lg hover:bg-slate-800 transition-all active:scale-[0.98] shadow-lg shadow-slate-200">
                    Update Profile
                </button>
            </div>
        </form>
    </main>

    <script>
        const DB_URL = "https://undersouthern-system-default-rtdb.asia-southeast1.firebasedatabase.app/users.json";
        let userFirebaseKey = null;
        let currentUserData = null;

        window.onload = async function() {
            const activeUserLogin = localStorage.getItem('activeUser');
            
            if (!activeUserLogin) {
                console.warn("No active user found in localStorage.");
                return;
            }

            try {
                const response = await fetch(DB_URL);
                const users = await response.json();
                
                // Tìm đúng user trong Firebase dựa trên login name
                for (let key in users) {
                    if (users[key].login === activeUserLogin) {
                        userFirebaseKey = key;
                        currentUserData = users[key];
                        break;
                    }
                }

                if (currentUserData) {
                    fillFormData(currentUserData);
                }
            } catch (error) {
                console.error("Firebase fetch error:", error);
            }

            // Tự động cập nhật thông tin trình duyệt đang dùng
            const userAgent = navigator.userAgent;
            let browserName = "Unknown Browser";
            if (userAgent.match(/chrome|chromium|crios/i)) browserName = "Chrome";
            else if (userAgent.match(/firefox|fxios/i)) browserName = "Firefox";
            else if (userAgent.match(/safari/i)) browserName = "Safari";
            else if (userAgent.match(/edg/i)) browserName = "Edge";
            
            document.getElementById('current-browser').innerText = browserName;
        };

        function fillFormData(data) {
            // Fill thông tin cơ bản
            document.getElementById('userEmail').value = data.email || "";
            document.getElementById('companyName').value = data.company || "UNDERSOUTHERN";
            document.getElementById('userAddress').value = data.address || "";
            document.getElementById('userPhone').value = data.phone || "";
            
            // Avatar
            const preview = document.getElementById('preview');
            const placeholder = document.getElementById('placeholder');
            if (data.avatar) {
                preview.src = data.avatar;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
                localStorage.setItem('userAvatar', data.avatar);
            }
        }

        function previewImage(input) {
            const preview = document.getElementById('preview');
            const placeholder = document.getElementById('placeholder');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    preview.src = imageData;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                    // Tạm thời lưu preview vào localStorage
                    localStorage.setItem('userAvatar', imageData);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function handleUpdate() {
            if (!userFirebaseKey) {
                alert("User session not found. Please re-login.");
                return;
            }

            const btn = document.getElementById('updateBtn');
            const originalText = btn.innerText;
            btn.innerText = "Syncing with Cloud...";
            btn.disabled = true;
            btn.style.opacity = "0.7";

            // Thu thập dữ liệu từ form
            const updatedData = {
                ...currentUserData, // Giữ lại thông tin cũ (như login, pass, access)
                email: document.getElementById('userEmail').value,
                company: document.getElementById('companyName').value,
                address: document.getElementById('userAddress').value,
                phone: document.getElementById('userPhone').value,
                avatar: localStorage.getItem('userAvatar') || "" // Lấy avatar mới nhất từ localStorage (base64)
            };

            try {
                // Gửi dữ liệu cập nhật lên đúng node của User trên Firebase
                const updateUrl = `https://undersouthern-system-default-rtdb.asia-southeast1.firebasedatabase.app/users/${userFirebaseKey}.json`;
                await fetch(updateUrl, {
                    method: 'PATCH',
                    body: JSON.stringify(updatedData)
                });

                btn.innerText = "Updated! Redirecting...";
                setTimeout(() => {
                    window.location.href = "https://undersouthern.asia/dashboard";
                }, 800);

            } catch (error) {
                console.error("Update failed:", error);
                alert("Failed to update profile. Please try again.");
                btn.innerText = originalText;
                btn.disabled = false;
                btn.style.opacity = "1";
            }
        }
    </script>
</body>
</html>
